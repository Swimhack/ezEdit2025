<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EzEdit FTP Integration Test</title>
  <link rel="stylesheet" href="../css/design-tokens.css">
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="../css/ui-components.css">
  <link rel="stylesheet" href="../css/toast.css">
  <style>
    .container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
    }
    .card {
      margin-bottom: 20px;
    }
    .result-box {
      margin-top: 20px;
      padding: 15px;
      border-radius: 6px;
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      height: 300px;
      overflow: auto;
    }
    .result-box pre {
      margin: 0;
      white-space: pre-wrap;
    }
    .success {
      background-color: #d1fae5;
      border-color: #10b981;
    }
    .error {
      background-color: #fee2e2;
      border-color: #ef4444;
    }
    .test-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    .connection-status {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-disconnected { background-color: #ef4444; }
    .status-connected { background-color: #10b981; }
    .status-connecting { background-color: #f59e0b; }
    .status-error { background-color: #7c3aed; }
  </style>
</head>
<body>
  <div class="container">
    <h1>EzEdit FTP Integration Test</h1>
    <p>This page tests the integration between the FTP backend and frontend JavaScript service.</p>
    
    <div class="connection-status">
      <div id="status-indicator" class="status-indicator status-disconnected"></div>
      <span id="status-text">Disconnected</span>
    </div>
    
    <div class="test-grid">
      <div class="card">
        <div class="card-header">
          <h2>Connection Settings</h2>
        </div>
        <div class="card-body">
          <form id="connection-form">
            <div class="form-group">
              <label for="site-id">Site ID</label>
              <input type="number" id="site-id" class="form-input" value="1" min="1" required>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn btn-primary">Connect</button>
              <button type="button" id="disconnect-btn" class="btn btn-danger" disabled>Disconnect</button>
            </div>
          </form>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2>Directory Operations</h2>
        </div>
        <div class="card-body">
          <form id="directory-form">
            <div class="form-group">
              <label for="path">Path</label>
              <input type="text" id="path" class="form-input" value="/" required>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn" disabled>List Directory</button>
            </div>
          </form>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2>File Operations</h2>
        </div>
        <div class="card-body">
          <form id="file-form">
            <div class="form-group">
              <label for="file-path">File Path</label>
              <input type="text" id="file-path" class="form-input" value="/readme.txt" required>
            </div>
            <div class="form-actions">
              <button type="submit" id="get-file-btn" class="btn" disabled>Get File</button>
              <button type="button" id="save-file-btn" class="btn btn-primary" disabled>Save File</button>
            </div>
          </form>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h2>File Content</h2>
        </div>
        <div class="card-body">
          <div class="form-group">
            <textarea id="file-content" class="form-input" rows="5" placeholder="File content will appear here..."></textarea>
          </div>
        </div>
      </div>
    </div>
    
    <div id="result" class="result-box">
      <h3>Results:</h3>
      <pre id="result-content">Integration test initialized. Use the forms above to test FTP operations.</pre>
    </div>
  </div>
  
  <script src="../js/ftp-service.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Elements
      const connectionForm = document.getElementById('connection-form');
      const directoryForm = document.getElementById('directory-form');
      const fileForm = document.getElementById('file-form');
      const disconnectBtn = document.getElementById('disconnect-btn');
      const getFileBtn = document.getElementById('get-file-btn');
      const saveFileBtn = document.getElementById('save-file-btn');
      const fileContent = document.getElementById('file-content');
      const resultContent = document.getElementById('result-content');
      const statusIndicator = document.getElementById('status-indicator');
      const statusText = document.getElementById('status-text');
      
      // FTP Service
      const ftpService = window.ezEdit.ftpService;
      
      // Update UI based on connection status
      function updateConnectionStatus(status) {
        statusIndicator.className = 'status-indicator';
        
        switch(status) {
          case 'connected':
            statusIndicator.classList.add('status-connected');
            statusText.textContent = 'Connected';
            disconnectBtn.disabled = false;
            directoryForm.querySelector('button').disabled = false;
            getFileBtn.disabled = false;
            saveFileBtn.disabled = false;
            break;
          case 'disconnected':
            statusIndicator.classList.add('status-disconnected');
            statusText.textContent = 'Disconnected';
            disconnectBtn.disabled = true;
            directoryForm.querySelector('button').disabled = true;
            getFileBtn.disabled = true;
            saveFileBtn.disabled = true;
            break;
          case 'connecting':
            statusIndicator.classList.add('status-connecting');
            statusText.textContent = 'Connecting...';
            break;
          case 'error':
            statusIndicator.classList.add('status-error');
            statusText.textContent = 'Connection Error';
            break;
        }
      }
      
      // Log results
      function logResult(message, isSuccess = true) {
        const timestamp = new Date().toLocaleTimeString();
        const formattedMessage = `[${timestamp}] ${message}`;
        resultContent.textContent = formattedMessage + '\n' + resultContent.textContent;
        
        if (isSuccess) {
          resultContent.parentElement.classList.add('success');
          resultContent.parentElement.classList.remove('error');
          
          // Reset after 2 seconds
          setTimeout(() => {
            resultContent.parentElement.classList.remove('success');
          }, 2000);
        } else {
          resultContent.parentElement.classList.add('error');
          resultContent.parentElement.classList.remove('success');
          
          // Reset after 2 seconds
          setTimeout(() => {
            resultContent.parentElement.classList.remove('error');
          }, 2000);
        }
      }
      
      // Connect to FTP server
      connectionForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const siteId = document.getElementById('site-id').value;
        updateConnectionStatus('connecting');
        
        try {
          ftpService.setSiteId(siteId);
          const result = await ftpService.connect();
          
          if (result.success) {
            updateConnectionStatus('connected');
            logResult(`Connected to FTP server. Connection ID: ${result.connectionId}`);
          } else {
            updateConnectionStatus('error');
            logResult(`Connection failed: ${result.error}`, false);
          }
        } catch (error) {
          updateConnectionStatus('error');
          logResult(`Connection error: ${error.message}`, false);
        }
      });
      
      // Disconnect from FTP server
      disconnectBtn.addEventListener('click', async () => {
        try {
          const result = await ftpService.disconnect();
          
          if (result.success) {
            updateConnectionStatus('disconnected');
            logResult(`Disconnected from FTP server: ${result.message}`);
          } else {
            logResult(`Disconnect failed: ${result.error}`, false);
          }
        } catch (error) {
          logResult(`Disconnect error: ${error.message}`, false);
        }
      });
      
      // List directory
      directoryForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const path = document.getElementById('path').value;
        
        try {
          const result = await ftpService.listDirectory(path);
          
          if (result.success) {
            const itemCount = result.items.length;
            const fileCount = result.items.filter(item => item.type === 'file').length;
            const dirCount = result.items.filter(item => item.type === 'directory').length;
            
            logResult(`Listed directory ${path}: ${itemCount} items (${fileCount} files, ${dirCount} directories)`);
            
            // Format and display the items
            const formattedItems = JSON.stringify(result.items, null, 2);
            fileContent.value = formattedItems;
          } else {
            logResult(`List directory failed: ${result.error}`, false);
          }
        } catch (error) {
          logResult(`List directory error: ${error.message}`, false);
        }
      });
      
      // Get file
      fileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const filePath = document.getElementById('file-path').value;
        
        try {
          const result = await ftpService.getFile(filePath);
          
          if (result.success) {
            logResult(`Retrieved file ${filePath}`);
            fileContent.value = result.content;
          } else {
            logResult(`Get file failed: ${result.error}`, false);
          }
        } catch (error) {
          logResult(`Get file error: ${error.message}`, false);
        }
      });
      
      // Save file
      saveFileBtn.addEventListener('click', async () => {
        const filePath = document.getElementById('file-path').value;
        const content = fileContent.value;
        
        try {
          const result = await ftpService.saveFile(filePath, content);
          
          if (result.success) {
            logResult(`Saved file ${filePath}: ${result.message}`);
          } else {
            logResult(`Save file failed: ${result.error}`, false);
          }
        } catch (error) {
          logResult(`Save file error: ${error.message}`, false);
        }
      });
      
      // Initialize
      updateConnectionStatus('disconnected');
    });
  </script>
</body>
</html>
